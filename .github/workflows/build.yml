name: Build BGShellBB10

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache BB10 NDK
      id: cache-ndk
      uses: actions/cache@v4
      with:
        path: ~/bbndk
        key: ${{ runner.os }}-bbndk-10.3.1
    
    - name: Set up BlackBerry 10 NDK
      if: steps.cache-ndk.outputs.cache-hit != 'true'
      run: |
        echo "BlackBerry 10 NDK setup required"
        echo "Please configure BB10 NDK as a GitHub secret or in Docker container"
        # This is a placeholder - you'll need to provide the NDK setup
        # Option 1: Download from archive if available
        # Option 2: Use a Docker container with pre-installed NDK
        # Option 3: Store NDK in GitHub releases and download it here
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
    
    - name: Source BB10 environment
      run: |
        # This assumes NDK is installed in ~/bbndk
        if [ -f ~/bbndk/bbndk-env.sh ]; then
          source ~/bbndk/bbndk-env.sh
        else
          echo "BB10 NDK not found. Skipping build."
          echo "See BUILD_SETUP.md for instructions on setting up the NDK."
          exit 1
        fi
    
    - name: Prepare build files
      run: |
        # Rename files to remove underscore prefix
        cp _BGShellBB10.pro BGShellBB10.pro
        cp _bar-descriptor.xml bar-descriptor.xml
        cp _Makefile Makefile
    
    - name: Build project
      run: |
        if [ -f ~/bbndk/bbndk-env.sh ]; then
          source ~/bbndk/bbndk-env.sh
          make clean
          make Device-Release
          make Device-Release.bar
        else
          echo "Skipping build - NDK not configured"
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bgshellbb10-build
        path: |
          Device-Release.bar
          arm/o.le-v7/BGShellBB10
        retention-days: 30
    
    - name: Build information
      run: |
        echo "Build completed"
        if [ -f Device-Release.bar ]; then
          ls -lh Device-Release.bar
        fi
