name: Build BB10

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  BB10_DOCKER_IMAGE: sw7ft/bb10-gcc9:latest

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Pull BB10 Docker image
      run: docker pull ${{ env.BB10_DOCKER_IMAGE }}
    
    - name: Prepare build files
      run: |
        cp _BGShellBB10.pro BGShellBB10.pro
        cp _bar-descriptor.xml bar-descriptor.xml
        cp _Makefile Makefile
    
    - name: Build BAR package in Docker
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ${{ env.BB10_DOCKER_IMAGE }} \
          bash -c "source /root/bbndk/bbndk-env_10_3_1_995.sh && \
                   export LC_ALL=C && \
                   make clean && \
                   make Device-Release && \
                   make Device-Release.bar"
    
    - name: Verify build artifacts
      run: |
        echo "Checking for build artifacts..."
        ls -lh Device-Release.bar || echo "Warning: Device-Release.bar not found"
        ls -lh arm/o.le-v7/BGShellBB10 || echo "Warning: Binary not found"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: bgshellbb10-${{ github.sha }}
        path: |
          Device-Release.bar
          arm/o.le-v7/BGShellBB10
        retention-days: 30
