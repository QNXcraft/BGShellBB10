name: Docker Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/bb10-build

jobs:
  docker-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    # Option 1: Use pre-built Docker image with BB10 NDK
    # Uncomment this when you have a Docker image ready
    # - name: Pull BB10 Build Image
    #   run: |
    #     docker pull ${{ env.DOCKER_IMAGE }}:latest || true
    
    # Option 2: Build Docker image on-the-fly
    # - name: Build BB10 Docker Image
    #   uses: docker/build-push-action@v5
    #   with:
    #     context: .
    #     file: ./Dockerfile.bb10
    #     push: false
    #     load: true
    #     tags: bb10-builder:latest
    #     cache-from: type=gha
    #     cache-to: type=gha,mode=max
    
    - name: Prepare build files
      run: |
        cp _BGShellBB10.pro BGShellBB10.pro
        cp _bar-descriptor.xml bar-descriptor.xml
        cp _Makefile Makefile
    
    - name: Build in Docker container
      run: |
        # This is a placeholder - adapt based on your Docker image
        echo "Docker-based build would run here"
        echo "Example:"
        echo "docker run --rm -v \$PWD:/workspace bb10-builder:latest make Device-Release"
        
        # When you have the Docker image ready, uncomment:
        # docker run --rm \
        #   -v $PWD:/workspace \
        #   -w /workspace \
        #   ${{ env.DOCKER_IMAGE }}:latest \
        #   bash -c "source /opt/bbndk/bbndk-env.sh && make clean && make Device-Release && make Device-Release.bar"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: bgshellbb10-docker-build
        path: |
          Device-Release.bar
          arm/o.le-v7/BGShellBB10
        retention-days: 30
